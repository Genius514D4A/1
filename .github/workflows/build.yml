# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
name: OpenWhisk
on:
  push:

env:
  # uncomment this to enable an ngrok access to the vm on test failure
  # enabling this you will get an ssh command to access the vm, active for one hour
  NGROK_DEBUG: yes
  # you need to add as secrets an ngrok token and a password to access the terminal 
  NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
  NGROK_PASSWORD: ${{ secrets.NGROK_PASSWORD }}
  # openwhisk env
  ANSIBLE_CMD: "ansible-playbook -i environments/local -e docker_image_prefix=testing"
  GRADLE_PROJS_SKIP: ""
 
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Add java
        uses: actions/setup-java@v2
        with:
          distribution: adopt-openj9
          java-version: 11
          cache: 'gradle'
      - run: true || ./tools/github/debugAction.sh
      - run: ./tools/github/waitIfDebug.sh
      - run: false || ./tools/github/debugAction.sh
      - run: ./tools/github/waitIfDebug.sh
      - run: false || ./tools/github/debugAction.sh
      - run: ./tools/github/waitIfDebug.sh
      - name: "Setup"
        run: ./tools/github/setup.sh
      - name: "Scala 2.13 compilation"
        run: TERM=dumb OW_SCALA_VERSION=2.13 ./gradlew :tests:compileTestScala
      - name: Run Unit Tests
        run: ./tools/github/runUnitTests.sh || ./tools/github/debugAction.sh
      - run: ./tools/github/waitIfDebug.sh
      #- name: upload logs
      #  run: ./tools/github/checkAndUploadLogs.sh unit db
      - name: Run System Tests
        run: ./tools/travis/runSystemTests.sh || ./tools/github/debugAction.sh
      - run: ./tools/github/waitIfDebug.sh
      #- name: upload logs
      #  run: ./tools/github/checkAndUploadLogs.sh system
      - name: Run MultiSystem Tests
        run: ./tools/travis/runMultiRuntimeTests.sh || ./tools/github/debugAction.sh
      - run: ./tools/github/waitIfDebug.sh
      #- name: upload logs
      #  run: ./tools/github/checkAndUploadLogs.sh multi-runtime
      - name: Run Standalone
        run: ./tools/travis/runStandaloneTests.sh || ./tools/github/debugAction.sh
      - run: ./tools/github/waitIfDebug.sh
      #- name: upload logs
      #  run: ./tools/github/checkAndUploadLogs.sh standalone
      - name: Performance tests
        run: ./tests/performance/preparation/deploy.sh || ./tools/github/debugAction.sh
      - run: ./tools/github/waitIfDebug.sh
      - run: TERM=dumb ./tests/performance/wrk_tests/latency.sh "https://172.17.0.1:10001" "$(cat ansible/files/auth.guest)" ./tests/performance/preparation/actions/noop.js 2m
      - run: TERM=dumb ./tests/performance/wrk_tests/latency.sh "https://172.17.0.1:10001" "$(cat ansible/files/auth.guest)" ./tests/performance/preparation/actions/async.js 2m
      - run: TERM=dumb ./tests/performance/wrk_tests/throughput.sh "https://172.17.0.1:10001" "$(cat ansible/files/auth.guest)" ./tests/performance/preparation/actions/noop.js 4 1 2 2m
      - run: TERM=dumb ./tests/performance/wrk_tests/throughput.sh "https://172.17.0.1:10001" "$(cat ansible/files/auth.guest)" ./tests/performance/preparation/actions/async.js 4 1 2 2m
      - run: TERM=dumb ./tests/performance/wrk_tests/throughput.sh "https://172.17.0.1:10001" "$(cat ansible/files/auth.guest)" ./tests/performance/preparation/actions/noop.js 100 110 2 2m
      - run: TERM=dumb ./tests/performance/wrk_tests/throughput.sh "https://172.17.0.1:10001" "$(cat ansible/files/auth.guest)" ./tests/performance/preparation/actions/async.js 100 110 2 2m
      - run: OPENWHISK_HOST="172.17.0.1" CONNECTIONS="100" REQUESTS_PER_SEC="1" ./gradlew gatlingRun-org.apache.openwhisk.ApiV1Simulation
      - run: OPENWHISK_HOST="172.17.0.1" MEAN_RESPONSE_TIME="1000" API_KEY="$(cat ansible/files/auth.guest)" EXCLUDED_KINDS="python:default,java:default,swift:default" PAUSE_BETWEEN_INVOKES="100" ./gradlew gatlingRun-org.apache.openwhisk.LatencySimulation
      - run: OPENWHISK_HOST="172.17.0.1" API_KEY="$(cat ansible/files/auth.guest)" CONNECTIONS="100" REQUESTS_PER_SEC="1" ./gradlew gatlingRun-org.apache.openwhisk.BlockingInvokeOneActionSimulation
      - run: OPENWHISK_HOST="172.17.0.1" API_KEY="$(cat ansible/files/auth.guest)" CONNECTIONS="100" REQUESTS_PER_SEC="1" ASYNC="true" ./gradlew gatlingRun-org.apache.openwhisk.BlockingInvokeOneActionSimulation
      # The following configuration does not make much sense. But we do not have enough users. But it's good to verify, that the test is still working.
      - run: OPENWHISK_HOST="172.17.0.1" USERS="1" REQUESTS_PER_SEC="1" ./gradlew gatlingRun-org.apache.openwhisk.ColdBlockingInvokeSimulation     
      #- name: upload logs
      #  run: ./tools/github/checkAndUploadLogs.sh perf
      
  